<!doctype html>
<!-- Site for Anxious Generation maps that uses Leaflet to render user-specified maps-->
<!-- Based on template from: https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/Structuring_content/Structuring_documents -->
<!-- Also incorporates content from https://getbootstrap.com/docs/5.3/getting-started/introduction/ -->

<html lang="en-US">
  <head>
   <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" 
    crossorigin="anonymous">
    <title>Anxious Generation Maps</title>

    <!-- Leaflet stylesheet and source code -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- The following MapLibre data was added in from https://openfreemap.org/quick_start/ -->
  <!-- Maplibre GL -->
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

  <!-- Maplibre GL Leaflet  -->
  <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet/leaflet-maplibre-gl.js"></script>

  <!-- Danfo-->
        <script src="https://cdn.jsdelivr.net/npm/danfojs@1.2.0/lib/bundle.min.js"></script>


    <style>
      html, body {
        height: 100%;
        margin: 0;
      }
      .leaflet-container {
        height: 600px;
        /* Commenting out the following line allowed my
        map to take up the full width of the page by default. 
        Based in part on https://stackoverflow.com/a/74628367/13097194*/
        /* width: 800px; */  
        max-width: 90%;
        max-height: 100%;
        background-color:rgba(255,0,0,0.0);
      }

    </style>



  </head>

<!-- The following script info comes from:
https://developer.mozilla.org/en-US/docs/Web/HTML/How_to/Add_JavaScript_to_your_web_page
-->

<body>
    <div class="container-fluid">
<div class = "row">
  <div class = "col-md-auto">
    <h3>Metrics by state</h3>
  </div>
</div>
<div class = "row">
  <div class = "col-md-auto">
    <p><strong>Note: These graphs show <i>fictional</i> placeholder data.</strong><p>
  </div>
</div>

<div class = "row">
  <div class = "col-md-auto">
    <label><b>Metric:</b>
      </label>
    </div>
<!-- Select tag is based on https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/select-->
 <!-- This page was also very helpful for linking <select> choices to our iframe's src value via JavaScript:
 https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event#select_element-->
 <!-- The bootstrap-specific select code shown here was based on the example(s) at
  https://getbootstrap.com/docs/5.3/forms/select/#default .-->
 <div class = "col-md-auto">
<select class="form-select" id="map-option" aria-label="Metric selection">
  <option value="index">Index of authoritative parenting</option>  
  <option value="pct_homeschooled">Share of 6-10 year olds homeschooled</option>
  <option value="pct_who_spank">Share of parents who report at 
least sometimes spanking 3-6 year olds</option>
  <option value="pct_with_smartphones">Share of 14-year-olds who have smartphones</option>
  <option value="average_hours">Average hours of unsupervised play 
outside for children ages 8-14</option>
</select>
</div>

  <!-- <div class = "col-md-auto">
    <label><b>Color style:</b>
    </label>
    </div>
  <div class = "col-md-auto">
<select class="form-select" id="color-option" aria-label="Metric selection">
  <option value="percentile">Percentile</option>  
  <option value="linear">Linear</option>
</select> -->
</div>
</div>

<div id='map'></div>


<script type="text/javascript">

const map_selectElement = document.getElementById("map-option");
df = dfd.readJSON("https://raw.githubusercontent.com/ifstudies/ag_js_map_test/refs/heads/master/ag_states_and_data.json"); 
  // Seeing what this DataFrame looks like:
  console.log(df);

// Converting the DataFrame back into a .json file so that it can be processed by Leaflet:
var agStateData = dfd.toJSON(df);

// Rendering percentile-based colors:
// (These colors were sourced from:
// /home/ifskjb3/Documents/ifsdocs/Scripts/chart_examples/ifs_dp_wgray_8_color.png )
function getColor(d) {
    return d >= 87.5 ? '#FFB77C' :
           d >= 75  ? '#E6B288' :
           d >= 62.5  ? '#CCAD94' :
           d >= 50  ? '#B3A8A0' :
           d >= 37.5   ? '#92919F' :
           d >= 25   ? '#6B6892' :
           d >= 12.5   ? '#433F85' :
                      '#1C1678';
}

function style(feature) // The feature variable here appears to be
// L.geojson. Note that it can still access the value of the select
// variable created earlier.
{
var metric = feature.properties.index; //Default setting
const selected_metric = map_selectElement.value;
console.log(selected_metric);
percentile_col = selected_metric + '_percentile';
// Note that we can use bracket notation to access elements
// of the GeoJSON feature--thus making it unnecessary to
// use if/else statements to map strings to attributes
// like feature.properties.pct_homeschooled_percentile .
metric = feature.properties[percentile_col];

// Returning the style argument:
return {
    fillColor: getColor(metric),
    weight: 0.5,
    opacity: 1,
    color: 'black',
    fillOpacity: 0.6
};
}

// Performing an initial render of the map:
map = L.map('map').setView([37.5, -98.5], 5);
L.maplibreGL({
style: '' // 'https://tiles.openfreemap.org/styles/bright',
}).addTo(map);
// This layerGroup will get replaced as needed by updateMap().
var layerGroup = new L.LayerGroup(); // Based on
// https://stackoverflow.com/a/53155822/13097194
layerGroup.addTo(map);
region_colors = L.geoJson(agStateData, {style: style});
layerGroup.addLayer(region_colors);


// The following line will allow updateMap to get called whenever
// the value of the select tag changes.
map_selectElement.addEventListener("change", updateMap);

function updateMap() {
    console.log("Called updateMap.");
    //map.remove(); // Removing, then recreating the map prevents
    // GeoJSON layers from getting added onto one another, which
    // is both inefficient and makes the background harder to read.
    // The code was based on https://stackoverflow.com/a/74513720/1309719 .
    layerGroup.removeLayer(region_colors);
    region_colors = L.geoJson(agStateData, {style: style});
    layerGroup.addLayer(region_colors);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" 
integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" 
crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" 
integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" 
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" 
integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" 
crossorigin="anonymous"></script>

</body>
</html>
